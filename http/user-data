#cloud-config
autoinstall:
  version: 1
  locale: en_US.UTF-8
  keyboard:
    layout: us
  network:
    network:
      version: 2
      ethernets:
        ens3:
          dhcp4: true
          dhcp-identifier: mac
  storage:
    layout:
      name: direct
  identity:
    hostname: ubuntu
    username: vagrant
    password: "$6$IFCD1Xs8AQ9nEeqD$xIwL9pm2560pERGz1tPd5ZMGvGg1CEw4rBG.6NnE4HcKyalMOu0uAeSSjXjY5.bjKotqEMGiemmXG6omzdnnj0"
  ssh:
    install-server: true
    allow-pw: true
    authorized-keys:
      - "ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA6NF8iallvQVp22WDkTkyrtvp9eWW6A8YVr+kz4TjGYe7gHzIw+niNltGEFHzD8+v1I2YJ6oXevct1YeS0o9HZyN1Q9qgCgzUFtdOKLv6IedplqoPkcmF0aYet2PkEDo3MlTBckFXPITAMzF8dJSIFo9D8HfdOV0IAdx4O7PtixWKn5y2hMNG0zQPyUecp4pzC6kivAIhyfHilFR61RGL+GPXQ2MWZWFYbAGjyiYJnAmCP3NOTd0jMZEnDkbUvxhMmBYSdETk1rRgm+R4LOzFUGaHqHDLKLX+FIPKcF96hrucXzcWyLbIbEgE98OHlnVYCzRdK8jlqm8tehUc9c9WhQ== vagrant insecure public key"
  packages:
    - qemu-guest-agent
    - cloud-initramfs-growroot
    - openssh-server
    - wget
    - build-essential
    - linux-headers-generic
    - dkms
  late-commands:
    - curtin in-target --target=/target -- sh -c 'echo "vagrant ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/vagrant'
    - curtin in-target --target=/target -- chmod 440 /etc/sudoers.d/vagrant
    - curtin in-target --target=/target -- sed -i 's/^#*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
    - curtin in-target --target=/target -- sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
    - curtin in-target --target=/target -- systemctl enable ssh